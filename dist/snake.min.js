!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).Snake=t()}(this,(function(){"use strict";var e=1,t=2,n=3,o=4,r={rows:20,columns:20};var i=0,s=function(){function e(e,t){this.x=e,this.y=t,this.uid=i++,this.node=null,this.oldClass="snake-map__col",this.class=this.oldClass,this.update()}var t=e.prototype;return t.render=function(){if(!this.node){var e=c();e.classList.add(this.oldClass),e.setAttribute("id",this.x+"_"+this.y),this.node=e}return this.node},t.update=function(){this.oldClass!==this.class&&(this.render().classList=this.class,this.oldClass=this.class)},t.addSnakeColor=function(){this.class="snake-map__col snake-map__col--snake"},t.addSnakeHeadColor=function(){this.class="snake-map__col snake-map__col--snake-head"},t.addSnakeHeadErrorColor=function(){this.class="snake-map__col snake-map__col--snake-head-error"},t.addFoodColor=function(){this.class="snake-map__col snake-map__col--food"},t.removeClass=function(){this.class="snake-map__col"},e}();function a(e){return"string"==typeof e}function d(e,t){t=t||0;for(var n=e.length-t,o=new Array(n);n--;)o[n]=e[n+t];return o}function u(e){return e instanceof s}function c(e){return void 0===e&&(e="div"),a(e)&&e.length?document.createElement(e):null}function l(){return document.createDocumentFragment()}function p(e){return document.createTextNode(e)}function h(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function f(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=new Array(t);n<t;n++)o[n]=e[n];return o}function _(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return(n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return f(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?f(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var o=0;return function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var v=function(e,t,n){void 0===n&&(n=null),this.id=e,this.data=t,this.next=n},m=function(){function e(){this.head=null,this.tail=null}var t,n,o,r=e.prototype;return r.append=function(e,t){var n=new v(e,t);this.tail&&(this.tail.next=n),this.head||(this.head=n),this.tail=n},r.prepend=function(e,t){var n=new v(e,t,this.head);this.head=n,this.tail||(this.tail=n)},r.find=function(e,t){if(void 0===t&&(t=null),!this.head||"function"!=typeof e)return null;for(var n=this.head;n;){try{if(e.apply(t,[n.data,n.id]))return n.data}catch(e){console.error(e)}n=n.next}return null},r.toArray=function(){var e=[];return this.for((function(t){e.push(t)}),this),e},r.for=function(e,t){if(void 0===t&&(t=null),this.head&&"function"==typeof e)for(var n=this.head;n;){try{e.apply(t,[n.data,n.id])}catch(e){console.error(e)}n=n.next}},r.filter=function(e,t){void 0===t&&(t=null);var n=[];if("function"!=typeof e)return n;for(var o=this.head;o;){try{e.apply(t,[o.data,o.id])&&n.push(o.data)}catch(e){console.error(e)}o=o.next}return n},r.remove=function(e){if(this.head){for(;this.head&&this.head.id===e;)this.head=this.head.next;for(var t=this.head;t&&t.next;)t.next.id===e?t.next=t.next.next:t=t.next;this.tail.id===e&&(this.tail=t)}},r.clean=function(){this.head=null,this.tail=null},t=e,(n=[{key:"length",get:function(){for(var e=0,t=this.head;t;)e++,t=t.next;return e}}])&&h(t.prototype,n),o&&h(t,o),e}(),y=Object.prototype.hasOwnProperty;function k(e,t){return y.call(e,t)}function S(e){return Math.floor(Math.random()*e)}function x(e,t,n){var o;try{o=n?e.apply(t,n):e.call(t)}catch(e){console.error(e)}return o}var C=function(){function e(){this.score=0,this.updateScoreCount=5,this.node=null,this.textNode=null,this.resultNode=null}var t=e.prototype;return t.speed=function(){return this.score<=50?1:this.score<=100?2:this.score<=200?3:this.score<=400?4:this.score<=800?5:this.score<=1500?6:this.score<=2e3?7:this.score<=4e3?8:this.score<=5e3?9:this.score<=1e4?10:void 0},t.renderTextNode=function(){return this.textNode||(this.textNode=p("Набрано очков: ")),this.textNode},t.renderResultNode=function(){if(!this.resultNode){var e=c();e.classList.add("snake-controls__score-result"),e.textContent=""+this.score,this.resultNode=e}return this.resultNode},t.render=function(){if(!this.node){var e=c();e.classList.add("snake-controls__score");var t=this.renderTextNode(),n=this.renderResultNode();e.appendChild(t),e.appendChild(n),this.node=e}return this.node},t.update=function(){this.score<=50?this.updateScoreCount=5:this.score<=100?this.updateScoreCount=10:this.score<=200?this.updateScoreCount=15:this.score<=400?this.updateScoreCount=20:this.score<=800?this.updateScoreCount=25:this.score<=1500?this.updateScoreCount=30:this.score<=2e3?this.updateScoreCount=35:this.score<=4e3?this.updateScoreCount=40:this.score<=5e3?this.updateScoreCount=45:this.score<=1e4&&(this.updateScoreCount=50),this.score+=this.updateScoreCount,this.renderResultNode().innerText=this.score},t.clear=function(){this.score=0,this.updateScoreCount=5,this.renderResultNode().innerText=this.score},t.normalizeScore=function(e){return Number(parseInt(e,10))},e}(),N=function(){function e(){this.speed=1,this.maxSpeed=10,this.timeout=150,this.node=null,this.textNode=null,this.resultNode=null,this.speedIntervals={1:150,2:140,3:130,4:120,5:110,6:100,7:80,8:60,9:40,10:20}}var t=e.prototype;return t.renderTextNode=function(){return this.textNode||(this.textNode=p("Скорость: ")),this.textNode},t.speedInterval=function(){return this.speedIntervals[this.speed]||this.speedIntervals[this.maxSpeed]},t.renderResultNode=function(){if(!this.resultNode){var e=c();e.classList.add("snake-controls__speed-result"),e.textContent=""+this.speed,this.resultNode=e}return this.resultNode},t.render=function(){if(!this.node){var e=c();e.classList.add("snake-controls__speed");var t=this.renderTextNode(),n=this.renderResultNode();e.appendChild(t),e.appendChild(n),this.node=e}return this.node},t.update=function(e){(e=this.normalizeSpeed(e))===this.speed||e>this.maxSpeed||(this.speed=e,this.renderResultNode().innerText=this.speed)},t.normalizeSpeed=function(e){return Number(parseInt(e,10))},e}(),b=function(){function e(){this.node=null,this.newGameNode=null,this.StartStopNode=null}var t=e.prototype;return t.render=function(e){if(!this.node){var t=c();t.classList.add("snake-controls__buttons"),t.appendChild(this.renderStartStop(e)),t.appendChild(this.renderNewGame(e)),this.node=t}return this.node},t.renderNewGame=function(e){if(!this.newGameNode){var t=c("button");t.classList.add("snake-controls__btn"),t.setAttribute("type","button"),t.textContent="Новая игра",t.addEventListener("click",(function(t){e.newGame()})),this.newGameNode=t}return this.newGameNode},t.renderStartStop=function(e){if(!this.StartStopNode){var t=c("button");t.classList.add("snake-controls__btn"),t.setAttribute("type","button"),t.textContent="Старт";var n=this;t.addEventListener("click",(function(t){e.startStop(),n.updateStartStopBtn(e)})),this.StartStopNode=t}return this.StartStopNode},t.updateStartStopBtn=function(e){var t="Старт";e._pause||(t="Пауза");var n=this.renderStartStop();t!==n.innerText&&(n.innerText=t)},e}();function w(e){var t,n;e._map=new m,e._mapNode=null,e._deferred=(t=[],n=function(e){for(var n,o=_(t);!(n=o()).done;)if(n.value.uid===e.uid)return!0;return!1},{add:function(e){u(e)&&!n(e)&&t.push(e)},update:function(){for(var e in t)if(t.hasOwnProperty(e)){var n=t[e];u(n)&&n.update()}t=[]}}),e.$on("render",e._renderMap)}function $(e,t,n){return e._map?e._map.find((function(e){return e.x===t&&e.y===n}),e):null}function g(e,t){A(e,t,"removeClass")}function F(e,t){A(e,t,"addSnakeColor")}function G(e,t){A(e,t,"addSnakeHeadColor")}function A(e,t,n){u(t)&&"function"==typeof t[n]&&(e._deferred.add(t),t[n]())}function L(){var e=c();return e.classList.add("snake-map__row"),e}function E(e){var t=this;switch(e){case 3:t._maxFoods=2;break;case 5:t._maxFoods=3;break;case 7:t._maxFoods=4;break;case 9:t._maxFoods=5}}function I(r){r._direction=t,r._step=!1,r._collision=!1,document.addEventListener("keydown",(function(i){!function(r,i){if(!r._step)return;switch(i.keyCode){case 38:case 87:T(r,e);break;case 39:case 68:T(r,t);break;case 40:case 83:T(r,n);break;case 37:case 65:T(r,o)}r._step=!1}(r,i)})),r.$on("newGame",r._newGameMove)}function T(r,i){var s=!1;switch(i){case e:r._direction!==n&&(s=!0);break;case t:r._direction!==o&&(s=!0);break;case n:r._direction!==e&&(s=!0);break;case o:r._direction!==t&&(s=!0)}s&&(r._direction=i)}function M(){this.pause(),this.start()}function O(e,t){this._init(e,t)}return function(e){e.prototype._init=function(e,t){var n=this;n.$el=function(e){if(a(e)){var t=document.querySelector(e);if(t)return t}else if(function(e){return!!e&&"object"==typeof e}(n=e)&&"nodeType"in n)return e;var n;return c("div")}(e),n.$options=function(e,t){var n,o={};for(n in e)r(n);for(n in t)k(e,n)||r(n);function r(n){o[n]=void 0===t[n]?e[n]:t[n]}return o}(r,t||{}),function(e){e._events=Object.create(null)}(n),function(e){e._score=new C,e._speed=new N,e._buttons=new b,e._controlsNode=null,e.$on("render",e._renderControls),e.$on("newGame",e._newGameControls),e.$on("collisionFood",e._collisionFoodControls)}(n),w(n),function(e){e._snake=new m,e._lengthStartSnake=3,e.$on("render",e._renderSnake),e.$on("collisionSnake",e._collisionSnake),e.$on("newGame",e._newGameSnake)}(n),function(e){e._foods=[],e._maxFoods=1,e.$on("render",e._renderFoods),e.$on("collisionFood",e._collisionFood),e.$on("newGame",e._newGameFoods),e.$on("updateSpeed",E)}(n),I(n),function(e){e._pause=!0,e._interval=null,e._isEndGame=!1,e.$on("updateSpeed",M)}(n),n.$el&&n._mount(n.$el)}}(O),function(e){e.prototype.$on=function(e,t){var n=this;if(Array.isArray(e))for(var o=0,r=e.length;o<r;o++)n.$on(e[o],t);else(n._events[e]||(n._events[e]=[])).push(t);return n},e.prototype.$once=function(e,t){var n=this;function o(){n.$off(e,o),t.apply(n,arguments)}return o.fn=t,n.$on(e,o),n},e.prototype.$off=function(e,t){var n=this;if(!arguments.length)return n._events=Object.create(null),n;if(Array.isArray(e)){for(var o=0,r=e.length;o<r;o++)n.$off(e[o],t);return n}var i,s=n._events[e];if(!s)return n;if(!t)return n._events[e]=null,n;for(var a=s.length;a--;)if((i=s[a])===t||i.fn===t){s.splice(a,1);break}return n},e.prototype.$emit=function(e){var t=this,n=t._events[e];if(n){n=n.length>1?d(n):n;for(var o=d(arguments,1),r=0,i=n.length;r<i;r++)x(n[r],t,o)}return t}}(O),function(e){e.prototype._renderControls=function(e){var t=this;if(!t._controlsNode){var n=c();n.classList.add("snake-controls"),n.appendChild(t._score.render()),n.appendChild(t._buttons.render(t)),n.appendChild(t._speed.render()),t._controlsNode=n}return e.appendChild(t._controlsNode),t._controlsNode},e.prototype._newGameControls=function(){var e=this;!function(e){e._score.clear()}(e),function(e){e._speed.update(1)}(e),e._buttons.updateStartStopBtn(e)},e.prototype._collisionFoodControls=function(){var e=this;!function(e){e._score.update()}(e),function(e,t){var n=t!==e._speed.speed;e._speed.update(t),n&&e.$emit("updateSpeed",t)}(e,e._score.speed())}}(O),function(e){e.prototype._createMap=function(){var e=this;if(!e._map.length)for(var t=0;t<e.$options.rows;t++)for(var n=0;n<e.$options.columns;n++){var o=new s(n,t);e._map.append(o.uid,o)}return e._map},e.prototype._renderMap=function(e){var t=this;if(!t._mapNode){for(var n=t._createMap().head,o=l(),r=L(),i=t.$options.columns,s=0;n;)r.append(n.data.render()),++s==i&&(o.append(r),r=L(),s=0),n=n.next;var a=c();a.classList.add("snake-map"),a.append(o),t._mapNode=a}return e.appendChild(t._mapNode),t._mapNode}}(O),function(e){e.prototype._mount=function(e){e.append(this._render()),this._update()},e.prototype._render=function(){var e=l();return this.$emit("render",e),e},e.prototype._update=function(){this.$emit("update"),this._deferred.update()}}(O),function(e){e.prototype._renderSnake=function(e){var t=this;if(e&&(t._snake.for((function(e){g(t,e)})),t._snake.clean()),!t._snake.length)for(var n=Math.ceil(t.$options.rows/2),o=Math.ceil(t.$options.columns/2),r=!0,i=0;i<t._lengthStartSnake;i++){var s=$(t,o-i,n);u(s)&&(r?(G(t,s),r=!1):F(t,s),t._snake.append(s.uid,s))}return t._snake},e.prototype._collisionSnake=function(){!function(e,t){A(e,t,"addSnakeHeadErrorColor")}(this,this._snake.head.data)},e.prototype._newGameSnake=function(){this._renderSnake(!0)}}(O),function(e){e.prototype._newGameFoods=function(){var e=this;e._maxFoods=1,e._cleanFoods(),e._renderFoods()},e.prototype._cleanFoods=function(){for(var e=this,t=0;t<e._foods.length;t++){var n=e._foods[t];u(n)&&g(e,n)}e._foods=[]},e.prototype._cleanFood=function(e){for(var t=this,n=0;n<t._foods.length;n++){var o=t._foods[n];if(u(o)&&o.uid==e){g(t,o),t._foods.splice(n,1);break}}},e.prototype._renderFoods=function(){var e=this;e._foods=[];for(var t=0;t<e._maxFoods;t++){var n=e._renderFood();n&&e._foods.push(n)}},e.prototype._renderFood=function(e){var t=this,n=$(t,S(t.$options.columns),S(t.$options.rows));return n&&t._getEmployedIds().indexOf(n.uid)<0?(function(e,t){A(e,t,"addFoodColor")}(t,n),e&&t._foods.push(n),n):t._renderFood(e)},e.prototype._collisionFood=function(e){var t=this,n=t._maxFoods,o=t.$options.rows*t.$options.columns-(t._snake.length+t._foods.length-1);n>o&&(n=o);for(var r=n-(t._foods.length-1),i=0;i<r;i++)t._renderFood(!0);t._cleanFood(e)},e.prototype._getEmployedIds=function(){var e=this,t=[];return e._snake.length&&(t=[].concat(t,e._snake.toArray().map((function(e){return e.uid})))),e._foods.length&&(t=[].concat(t,e._foods.map((function(e){return e.uid})))),t}}(O),function(r){r.prototype._move=function(){var r=this,i=r._snake.head.data,s=function(r,i,s){var a=r._direction;switch(a){case e:case n:var d=a===e?s-1:s+1;return d>=r.$options.rows?d=0:d<0&&(d=r.$options.rows-1),$(r,i,d);case t:case o:var u=a===o?i-1:i+1;return u>=r.$options.columns?u=0:u<0&&(u=r.$options.columns-1),$(r,u,s)}return null}(r,i.x,i.y);if(function(e,t){if(u(t)){var n=e._snake.toArray().map((function(e){return e.uid})),o=n.indexOf(t.uid);return o>=0&&o!==n.length-1}return!1}(r,s))return r.$emit("collisionSnake"),r._isEndGame=!0,void r._update();(function(e,t){if(u(t)){return e._foods.map((function(e){return e.uid})).indexOf(t.uid)>=0}return!1})(r,s)&&(r.$emit("collisionFood",s.uid),r._collision=!0),r._collision||function(e){if(e._snake.length){var t=e._snake.tail;u(t.data)&&(g(e,t.data),e._snake.remove(t.id))}}(r),function(e,t){if(u(t)){if(e._snake.length>1&&e._snake.head){var n=e._snake.head.data;u(n)&&F(e,n)}G(e,t),e._snake.prepend(t.uid,t)}}(r,s),r._update(),r._collision=!1,r._step=!0},r.prototype._newGameMove=function(){var e=this;e._step=!1,e._collision=!1,e._direction=t}}(O),function(e){e.prototype.newGame=function(){var e=this;e.pause(),e.$emit("newGame"),e._update(),e._isEndGame=!1},e.prototype.start=function(){var e=this;if(!e._isEndGame)return e._pause=!1,e._interval=setInterval((function(){e._isEndGame?e.pause():e._move()}),function(e){return e._speed.speedInterval()}(e))},e.prototype.pause=function(){var e=this;e._interval&&(clearInterval(e._interval),e._interval=null,e._pause=!0)},e.prototype.startStop=function(){var e=this;e._pause?e.start():e.pause()}}(O),O}));
